<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultas Temporales - DNI/RUC</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .consulta-card {
            border-left: 4px solid #007bff;
            margin-bottom: 1rem;
        }
        .dni-card { border-left-color: #28a745; }
        .ruc-card { border-left-color: #ffc107; }
        .json-viewer {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container my-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-database me-2"></i>Consultas Temporales DNI/RUC</h2>
                    <div>
                        <button class="btn btn-warning" onclick="limpiarConsultas()">
                            <i class="fas fa-trash me-1"></i>Limpiar Antiguas
                        </button>
                        <a href="/fiscalizador/actas-contra" class="btn btn-primary">
                            <i class="fas fa-arrow-left me-1"></i>Volver al Formulario
                        </a>
                    </div>
                </div>
                
                <!-- Filtros -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">Filtrar por tipo:</label>
                                <select id="filtroTipo" class="form-select" onchange="cargarConsultas()">
                                    <option value="">Todos</option>
                                    <option value="dni">Solo DNI</option>
                                    <option value="ruc">Solo RUC</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Buscar número:</label>
                                <input type="text" id="filtroNumero" class="form-control" placeholder="DNI o RUC" onkeyup="cargarConsultas()">
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button class="btn btn-info" onclick="cargarConsultas()">
                                    <i class="fas fa-refresh me-1"></i>Actualizar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Lista de consultas -->
                <div id="consultasContainer">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p class="mt-2">Cargando consultas...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function cargarConsultas() {
            const tipo = document.getElementById('filtroTipo').value;
            const numero = document.getElementById('filtroNumero').value;
            
            try {
                let url = '/consultas-temporales.php?action=list';
                if (tipo) url += `&tipo=${tipo}`;
                if (numero) url += `&numero=${numero}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                mostrarConsultas(data.consultas || []);
            } catch (error) {
                console.error('Error cargando consultas:', error);
                document.getElementById('consultasContainer').innerHTML = 
                    '<div class="alert alert-danger">Error cargando las consultas</div>';
            }
        }
        
        function mostrarConsultas(consultas) {
            const container = document.getElementById('consultasContainer');
            
            if (consultas.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No hay consultas almacenadas</div>';
                return;
            }
            
            let html = `<div class="mb-3"><strong>Total: ${consultas.length} consultas</strong></div>`;
            
            consultas.forEach(consulta => {
                const isDNI = consulta.dni;
                const cardClass = isDNI ? 'dni-card' : 'ruc-card';
                const icon = isDNI ? 'fa-id-card' : 'fa-building';
                const tipo = isDNI ? 'DNI' : 'RUC';
                const numero = isDNI ? consulta.dni : consulta.ruc;
                const nombre = isDNI ? consulta.nombre_completo : consulta.razon_social;
                
                html += `
                    <div class="card consulta-card ${cardClass}">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h5 class="card-title">
                                        <i class="fas ${icon} me-2"></i>${tipo}: ${numero}
                                    </h5>
                                    <p class="card-text"><strong>${nombre}</strong></p>
                                    ${consulta.direccion ? `<p class="text-muted"><i class="fas fa-map-marker-alt me-1"></i>${consulta.direccion}</p>` : ''}
                                    ${consulta.departamento ? `<p class="text-muted"><i class="fas fa-location-dot me-1"></i>${consulta.departamento} - ${consulta.provincia} - ${consulta.distrito}</p>` : ''}
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>${consulta.timestamp} | 
                                        <i class="fas fa-api me-1"></i>${consulta.fuente}
                                    </small>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button class="btn btn-sm btn-outline-info me-1" onclick="verJSON('${consulta.archivo}')">
                                        <i class="fas fa-code me-1"></i>Ver JSON
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="eliminarConsulta('${consulta.archivo}')">
                                        <i class="fas fa-trash me-1"></i>Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        async function verJSON(archivo) {
            // Aquí podrías implementar un modal para mostrar el JSON completo
            alert('Función para ver JSON completo (por implementar)');
        }
        
        async function eliminarConsulta(archivo) {
            if (!confirm('¿Estás seguro de eliminar esta consulta?')) return;
            
            try {
                const response = await fetch(`/consultas-temporales.php?action=delete&archivo=${archivo}`);
                const data = await response.json();
                
                if (data.success) {
                    cargarConsultas();
                } else {
                    alert('Error eliminando la consulta: ' + data.error);
                }
            } catch (error) {
                alert('Error eliminando la consulta');
            }
        }
        
        async function limpiarConsultas() {
            if (!confirm('¿Eliminar consultas antiguas (más de 7 días)?')) return;
            
            try {
                const response = await fetch('/consultas-temporales.php?action=clean');
                const data = await response.json();
                
                alert(data.message);
                cargarConsultas();
            } catch (error) {
                alert('Error limpiando consultas');
            }
        }
        
        // Cargar consultas al inicio
        document.addEventListener('DOMContentLoaded', cargarConsultas);
    </script>
</body>
</html>
